function iAC(a,b){var c=document.getElementById(a);if(c){var d=c.scrollTop,e=0,f=c.selectionStart||"0"==c.selectionStart?"ff":document.selection?"ie":!1;if("ie"==f){c.focus();var g=document.selection.createRange();g.moveStart("character",-c.value.length),e=g.text.length}else"ff"==f&&(e=c.selectionStart);var h=c.value.substring(0,e),i=c.value.substring(e,c.value.length);if(c.value=h+b+i,e+=b.length,"ie"==f){c.focus();var j=document.selection.createRange();j.moveStart("character",-c.value.length),j.moveStart("character",e),j.moveEnd("character",0),j.select()}else"ff"==f&&(c.selectionStart=e,c.selectionEnd=e,c.focus());c.scrollTop=d}}Rchat.internal={},Rchat.internal.init=function(){localStorage.chat_op||localStorage.setItem("chat_op","0"),$("body").append(Rchat.config.html),Rchat.internal.op_cl($("#chat_btn")),Rchat.internal.vars.receiving=1,Rchat.internal.get_data(),Rchat.internal.init_send(),Rchat.internal.smilies_init(),Rchat.internal.reset()},Rchat.internal.op_cl=function(a){"1"==localStorage.getItem("chat_op")&&($("#chat_inner").toggleClass("chat_open"),Rchat.internal.vars.receiving=1),a.click(function(){$("#chat_inner").toggleClass("chat_open"),localStorage.setItem("chat_op",$("#chat_inner").hasClass("chat_open")?"1":"0"),"1"==localStorage.chat_op&&"0"==!$("#chat_btn_notif").text()&&($("#chat_btn_notif").text("0"),$("#chat_content").scrollTop($("#chat_content")[0].scrollHeight))})},Rchat.internal.reset=function(){Rchat.internal.vars.resetting||$("#chat_head>span").click(function(){$(this).css({cursor:"not-allowed",opacity:"0.9"}),Rchat.internal.vars.resetting=1,localStorage.removeItem("chat_op"),localStorage.removeItem("emo"),Rchat.internal.vars.resetting=0,$(this).css({cursor:"pointer",opacity:"1.0"}),window.location.reload()})},Rchat.internal.vars={},Rchat.internal.vars.sending=0,Rchat.internal.vars.receiving=1,Rchat.internal.vars.mess_per_page=20,Rchat.internal.vars.ct=[],Rchat.internal.vars.auth_data=[],Rchat.internal.vars.index=0,Rchat.internal.vars.resetting=0,Rchat.internal.get_data=function(){Rchat.internal.vars.receiving?$.get(Rchat.config.topic+"?view=newest",function(a){Rchat.internal.vars.index++,$("#chat_content>center").length&&$("#chat_content>center").remove();var b=$("#chat_sis",a),c=b.length,d=0;if(Rchat.internal.vars.auth_data=[$("[name='auth[]']",a).eq(0).val(),$("[name='auth[]']",a).eq(1).val()],c<Rchat.internal.vars.ct.length)for(Rchat.internal.vars.ct=[],$("#chat_content").empty(),d;d<c;d++)Rchat.internal.vars.ct.push(b.eq(d).html()),$("#chat_content").append(b.eq(d).html()),"0"!=localStorage.chat_op||1!=b.eq(d).html().split(_userdata.username).length||Rchat.internal.vars.index||$("#chat_btn_notif").text(parseInt($("#chat_btn_notif").text().match(/\d+/))+1),$("#chat_content").scrollTop($("#chat_content")[0].scrollHeight);else for(d;d<c;d++)b.eq(d).html()!=Rchat.internal.vars.ct[d]&&d<Rchat.internal.vars.ct.length?(Rchat.internal.vars.ct[d]=b.eq(d).html(),$("#chat_content>div").eq(d).html(b.eq(d).html())):b.eq(d).html()!=Rchat.internal.vars.ct[d]&&($("#chat_content").append(b.eq(d).html()),"0"!=localStorage.chat_op||1!=b.eq(d).html().split(_userdata.username).length||Rchat.internal.vars.index||$("#chat_btn_notif").text(parseInt($("#chat_btn_notif").text().match(/\d+/))+1),$("#chat_content").scrollTop($("#chat_content")[0].scrollHeight),Rchat.internal.vars.ct[d]=b.eq(d).html());setTimeout(function(){Rchat.internal.get_data()},Rchat.config.delay)}):setTimeout(function(){Rchat.internal.get_data()},Rchat.config.delay)},Rchat.internal.comp=function(a){return'<div id="chat_sis" class="chat"><div id="chat_bl"><div id="chat_group"><div id="chat_avatar"><img src="'+_userdata.avatar.match(/"(.+?)(?=")/)[1]+'"/></div><div id="chat_name">'+_userdata.username+'</div></div><div id="chat_message">'+a+"</div></div></div>"},Rchat.internal.send=function(a){if(!Rchat.internal.vars.sending){if(0==a.length)return $("#chat_btts").after("<div id='send_fail'>"+Rchat.lang.no_empty+"</div>"),void setTimeout(function(){$("#send_fail").fadeOut(function(){$("#send_fail").remove()})},2e3);Rchat.internal.vars.sending=1,$("#chat_form_send").toggleClass("act_bt"),$.post("/post",{mode:"reply",t:Rchat.config.topic.match(/\d+/)[0],message:Rchat.internal.comp(a),post:"Ok",auth:Rchat.internal.vars.auth_data},function(){Rchat.internal.after_send()})}},Rchat.internal.after_send=function(){Rchat.internal.vars.sending=0,$(".act_bt").removeClass("act_bt")},Rchat.internal.init_send=function(){$("#chat_form_send").click(function(){Rchat.internal.send($("#chat_form_input").val()),$("#chat_form_input").val("")})},Rchat.internal.smilies={},Rchat.internal.smilies.populate=function(){var a;void 0!=localStorage.emo?(a=localStorage.emo,$("#chat_smi_pop").append(a.replace(/alt/g,"data_emoji")),$("[data_emoji]").wrap("<span></span>"),$("[data_emoji]").click(function(){iAC("chat_form_input",$(this).attr("data_emoji"))})):$.get("/smilies.forum?mode=smilies_frame",function(b){a=$(b).filter(".smiley-element").html(),localStorage.emo=a,$("#chat_smi_pop").append(a.replace(/alt/g,"data_emoji")),$("[data_emoji]").wrap("<span></span>"),$("[data_emoji]").click(function(){iAC("chat_form_input",$(this).attr("data_emoji"))})})},Rchat.internal.smilies_bind=function(){1==$("#chat_smi_pop").length?$("#chat_smi_pop").remove():($("#chat_form").append("<div id='chat_smi_pop'><div id='chat_smi_pop_head'>"+Rchat.lang.emoji_head+"</div></div>"),Rchat.internal.smilies.populate())},Rchat.internal.smilies_init=function(){$("#chat_smilies").click(function(){Rchat.internal.smilies_bind()})},Rchat.internal.init();
